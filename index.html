<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maritime Tycoon</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: white;
        }

        .header {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #4a90e2;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-title {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #4CAF50;
        }

        .debt {
            color: #ff6b6b;
        }

        .menu-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 30px;
            flex-wrap: wrap;
        }

        .menu-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .menu-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .menu-btn.fleet { background: linear-gradient(45deg, #2196F3, #1976D2); }
        .menu-btn.shop { background: linear-gradient(45deg, #FF9800, #F57C00); }
        .menu-btn.bank { background: linear-gradient(45deg, #9C27B0, #7B1FA2); }

        .screen {
            display: none;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .screen.active {
            display: block;
        }

        .back-btn {
            background: #607D8B;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .destination-card.locked {
            opacity: 0.6;
            border-left-color: #666;
        }

        .xp-requirement {
            color: #ff9800;
            font-weight: bold;
        }

        .mission-timer {
            color: #2196F3;
            font-weight: bold;
        }

        .fleet-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .fleet-tab {
            background: rgba(255,255,255,0.1);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fleet-tab.active {
            background: #4CAF50;
        }

        .fleet-tab:hover {
            background: rgba(255,255,255,0.2);
        }

        .fleet-tab.active:hover {
            background: #45a049;
        }

        .ship-card, .destination-card, .upgrade-card {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }

        .mission-btn, .upgrade-btn, .bank-btn {
            background: #4CAF50;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            margin-top: 10px;
        }

        .mission-btn:disabled, .upgrade-btn:disabled, .bank-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            height: 40px;
            background: linear-gradient(90deg, #1e3c72 0%, #2a5298 50%, #4a90e2 100%);
            border-radius: 20px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .progress-ship {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            transition: left 0.3s ease;
            z-index: 10;
        }

        .progress-waves {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: repeating-linear-gradient(
                90deg,
                rgba(255,255,255,0.1) 0px,
                rgba(255,255,255,0.1) 10px,
                rgba(255,255,255,0.2) 10px,
                rgba(255,255,255,0.2) 20px
            );
            animation: waves 2s linear infinite;
        }

        @keyframes waves {
            0% { transform: translateX(-20px); }
            100% { transform: translateX(0px); }
        }

        .input-group {
            margin: 10px 0;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
            margin-top: 5px;
        }

        .input-group input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .loan-info {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* Bouton son */
        .sound-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            border: none;
            padding: 10px;
            border-radius: 50%;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .sound-toggle:hover {
            background: rgba(0,0,0,0.9);
            transform: scale(1.1);
        }

        .sound-toggle.muted {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üö¢ Maritime Tycoon üèóÔ∏è</h1>
        <p>G√©rez votre empire portuaire !</p>
    </div>

    <!-- Bouton son -->
    <button id="sound-toggle" class="sound-toggle" onclick="toggleSound()">üîä</button>

    <!-- √âcran principal -->
    <div id="main-screen" class="screen active">
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-title">üí∞ Argent</div>
                <div class="stat-value" id="money">10000</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">‚≠ê Exp√©rience</div>
                <div class="stat-value" id="xp">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">üè¶ √âpargne</div>
                <div class="stat-value" id="savings">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">üìà Revenu Passif</div>
                <div class="stat-value" id="passive-income">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">üí∏ Dettes</div>
                <div class="stat-value debt" id="debt">0</div>
            </div>
        </div>

        <!-- R√©compense quotidienne -->
        <div style="max-width: 600px; margin: 20px auto;">
            <div class="card" style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #FFC107; text-align: center;">
                <h3>üéÅ R√©compense Quotidienne</h3>
                <div id="main-daily-reward-info"></div>
            </div>
        </div>

        <div class="menu-container">
            <button class="menu-btn fleet" onclick="showScreen('fleet')">üö¢ Gestion Flotte</button>
            <button class="menu-btn shop" onclick="showScreen('shop')">üõí Boutique</button>
            <button class="menu-btn bank" onclick="showScreen('bank')">üè¶ Banque</button>
        </div>

        <!-- Options de sauvegarde -->
        <div style="max-width: 600px; margin: 20px auto;">
            <div class="card" style="background: rgba(100, 100, 100, 0.1); border-left: 4px solid #607D8B; text-align: center;">
                <h3>‚öôÔ∏è Options de Jeu</h3>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 15px;">
                    <button class="menu-btn" onclick="forceSave()" style="background: linear-gradient(45deg, #4CAF50, #45a049); padding: 10px 20px; font-size: 0.9em;">
                        üíæ Sauvegarder
                    </button>
                    <button class="menu-btn" onclick="confirmReset()" style="background: linear-gradient(45deg, #f44336, #d32f2f); padding: 10px 20px; font-size: 0.9em;">
                        üîÑ Nouvelle Partie
                    </button>
                </div>
                <p style="font-size: 0.8em; opacity: 0.7; margin-top: 10px;">
                    Le jeu se sauvegarde automatiquement toutes les 30 secondes
                </p>
            </div>
        </div>
    </div>

    <!-- √âcran gestion flotte -->
    <div id="fleet-screen" class="screen">
        <button class="back-btn" onclick="showScreen('main')">‚Üê Retour</button>
        <h2>üö¢ Gestion de la Flotte</h2>
        
        <!-- Indicateur de renouvellement des missions -->
        <div style="max-width: 600px; margin: 0 auto 20px;">
            <div class="card" style="background: rgba(255, 152, 0, 0.1); border-left: 4px solid #FF9800; text-align: center; padding: 10px;">
                <div id="mission-refresh-info" style="font-size: 0.9em;"></div>
            </div>
        </div>
        
        <div class="fleet-tabs">
            <button class="fleet-tab active" onclick="switchFleetTab('cargo')">üö¢ Cargo</button>
            <button class="fleet-tab" onclick="switchFleetTab('passenger')">üõ≥Ô∏è Passagers</button>
        </div>
        
        <div class="content-grid">
            <div class="card">
                <h3 id="fleet-ships-title">Vos Navires Cargo</h3>
                <div id="ships-list"></div>
            </div>
            
            <div class="card">
                <h3 id="fleet-destinations-title">Destinations Cargo</h3>
                <div id="destinations-list"></div>
            </div>
        </div>
    </div>

    <!-- √âcran boutique -->
    <div id="shop-screen" class="screen">
        <button class="back-btn" onclick="showScreen('main')">‚Üê Retour</button>
        <h2>üõí Boutique d'Am√©liorations</h2>
        
        <div class="content-grid">
            <div class="card">
                <h3>Am√©liorations du Port</h3>
                <div id="port-upgrades"></div>
            </div>
            
            <div class="card">
                <h3>Am√©liorations Navires Cargo</h3>
                <div id="cargo-ship-upgrades"></div>
            </div>
            
            <div class="card">
                <h3>Am√©liorations Navires Passagers</h3>
                <div id="passenger-ship-upgrades"></div>
            </div>
            
            <div class="card">
                <h3>Nouveaux Navires Cargo</h3>
                <div id="new-cargo-ships"></div>
            </div>
            
            <div class="card">
                <h3>Nouveaux Navires Passagers</h3>
                <div id="new-passenger-ships"></div>
            </div>
        </div>
    </div>

    <!-- √âcran banque -->
    <div id="bank-screen" class="screen">
        <button class="back-btn" onclick="showScreen('main')">‚Üê Retour</button>
        <h2>üè¶ Services Bancaires</h2>
        
        <!-- R√©sum√© financier -->
        <div class="card" style="margin-bottom: 20px; background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4CAF50;">
            <h3>üí∞ Votre Situation Financi√®re</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
                    <p style="opacity: 0.8; margin-bottom: 5px;">üíµ Argent Liquide</p>
                    <p style="font-size: 1.5em; font-weight: bold; color: #4CAF50;" id="bank-liquid-money">0‚Ç¨</p>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
                    <p style="opacity: 0.8; margin-bottom: 5px;">üè¶ √âpargne</p>
                    <p style="font-size: 1.5em; font-weight: bold; color: #2196F3;" id="bank-savings">0‚Ç¨</p>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
                    <p style="opacity: 0.8; margin-bottom: 5px;">üí∏ Dettes</p>
                    <p style="font-size: 1.5em; font-weight: bold; color: #ff6b6b;" id="bank-debt">0‚Ç¨</p>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center;">
                    <p style="opacity: 0.8; margin-bottom: 5px;">üìä Patrimoine Net</p>
                    <p style="font-size: 1.5em; font-weight: bold;" id="bank-net-worth">0‚Ç¨</p>
                </div>
            </div>
        </div>
        
        <div class="content-grid">
            <div class="card">
                <h3>Compte √âpargne</h3>
                <p>Taux d'int√©r√™t: 2% par heure</p>
                <div class="input-group">
                    <label>Montant √† d√©poser:</label>
                    <input type="number" id="deposit-amount" placeholder="Montant">
                </div>
                <button class="bank-btn" onclick="deposit()">D√©poser</button>
                <button class="bank-btn" onclick="withdraw()">Retirer</button>
            </div>
            
            <div class="card">
                <h3>Pr√™ts Bancaires</h3>
                <p>Taux d'int√©r√™t: 5% par heure</p>
                <div class="input-group">
                    <label>Montant du pr√™t:</label>
                    <input type="number" id="loan-amount" placeholder="Montant">
                </div>
                <button class="bank-btn" onclick="takeLoan()">Emprunter</button>
                <div id="loan-info"></div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- Chargement de Tone.js via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <script>
        // Gestionnaire audio
        class AudioManager {
            constructor() {
                this.isEnabled = localStorage.getItem('maritimeTycoonSound') !== 'false';
                this.isInitialized = false;
                this.synths = {};
                this.backgroundMusic = null;
                this.updateSoundButton();
            }

            async initialize() {
                if (this.isInitialized || typeof Tone === 'undefined') return;
                
                try {
                    await Tone.start();
                    
                    // Cr√©er les synth√©tiseurs pour diff√©rents sons
                    this.synths = {
                        coin: new Tone.Synth({
                            oscillator: { type: "triangle" },
                            envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.3 }
                        }).toDestination(),
                        
                        ship: new Tone.Synth({
                            oscillator: { type: "sine" },
                            envelope: { attack: 0.5, decay: 0.3, sustain: 0.7, release: 1.5 }
                        }).toDestination(),
                        
                        success: new Tone.PolySynth().toDestination(),
                        
                        error: new Tone.Synth({
                            oscillator: { type: "sawtooth" },
                            envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 }
                        }).toDestination(),
                        
                        reward: new Tone.PolySynth().toDestination()
                    };

                    // Son d'ambiance oc√©anique (optionnel)
                    this.ambientNoise = new Tone.Noise("pink").toDestination();
                    this.ambientNoise.volume.value = -30; // Tr√®s bas
                    
                    this.isInitialized = true;
                    console.log("üéµ Syst√®me audio initialis√©");
                } catch (error) {
                    console.log("‚ùå Erreur d'initialisation audio:", error);
                }
            }

            updateSoundButton() {
                const button = document.getElementById('sound-toggle');
                if (button) {
                    button.textContent = this.isEnabled ? 'üîä' : 'üîá';
                    button.classList.toggle('muted', !this.isEnabled);
                }
            }

            toggle() {
                this.isEnabled = !this.isEnabled;
                localStorage.setItem('maritimeTycoonSound', this.isEnabled.toString());
                this.updateSoundButton();
                
                if (!this.isEnabled && this.backgroundMusic) {
                    this.stopAmbient();
                }
            }

            async playSound(type, options = {}) {
                if (!this.isEnabled) return;
                
                await this.initialize();
                if (!this.isInitialized) return;

                try {
                    switch (type) {
                        case 'coin':
                            // Son de pi√®ces qui tombent
                            this.synths.coin.triggerAttackRelease("C5", "8n");
                            setTimeout(() => this.synths.coin.triggerAttackRelease("E5", "8n"), 50);
                            setTimeout(() => this.synths.coin.triggerAttackRelease("G5", "8n"), 100);
                            break;

                        case 'ship_departure':
                            // Corne de brume
                            this.synths.ship.triggerAttackRelease("C3", "2n");
                            break;

                        case 'mission_success':
                            // M√©lodie de succ√®s
                            const successNotes = ["C4", "E4", "G4", "C5"];
                            successNotes.forEach((note, i) => {
                                setTimeout(() => this.synths.success.triggerAttackRelease(note, "8n"), i * 100);
                            });
                            break;

                        case 'error':
                            // Son d'erreur
                            this.synths.error.triggerAttackRelease("C2", "4n");
                            break;

                        case 'daily_reward':
                            // Fanfare de r√©compense
                            const rewardNotes = ["C4", "G4", "C5", "E5", "G5"];
                            rewardNotes.forEach((note, i) => {
                                setTimeout(() => this.synths.reward.triggerAttackRelease(note, "8n"), i * 80);
                            });
                            break;

                        case 'upgrade':
                            // Son d'am√©lioration
                            this.synths.success.triggerAttackRelease("F4", "8n");
                            setTimeout(() => this.synths.success.triggerAttackRelease("A4", "8n"), 100);
                            break;

                        case 'purchase':
                            // Son d'achat
                            this.synths.coin.triggerAttackRelease("G4", "8n");
                            setTimeout(() => this.synths.coin.triggerAttackRelease("C5", "8n"), 100);
                            break;
                    }
                } catch (error) {
                    console.log("Erreur lecture son:", error);
                }
            }

            startAmbient() {
                if (!this.isEnabled || !this.isInitialized) return;
                
                try {
                    if (this.ambientNoise) {
                        this.ambientNoise.start();
                    }
                } catch (error) {
                    console.log("Erreur ambiance:", error);
                }
            }

            stopAmbient() {
                try {
                    if (this.ambientNoise) {
                        this.ambientNoise.stop();
                    }
                } catch (error) {
                    console.log("Erreur arr√™t ambiance:", error);
                }
            }
        }

        // Instance globale du gestionnaire audio
        const audioManager = new AudioManager();

        // Fonction pour basculer le son
        function toggleSound() {
            audioManager.toggle();
        }

        // Destinations cargo avec temps de navigation en millisecondes et XP requis pour d√©bloquer
        const cargoDestinations = [
            { name: "üá´üá∑ Le Havre", duration: 300000, baseReward: 200, baseXP: 10, requiredXP: 0, unlocked: true }, // 5 min
            { name: "üá≥üá± Rotterdam", duration: 300000, baseReward: 250, baseXP: 12, requiredXP: 0, unlocked: true }, // 5 min
            { name: "üá¨üáß Londres", duration: 300000, baseReward: 300, baseXP: 15, requiredXP: 0, unlocked: true }, // 5 min
            { name: "üá™üá∏ Barcelone", duration: 3600000, baseReward: 800, baseXP: 40, requiredXP: 50, unlocked: false }, // 1h
            { name: "üáÆüáπ G√™nes", duration: 3600000, baseReward: 900, baseXP: 45, requiredXP: 75, unlocked: false }, // 1h
            { name: "üá©üá™ Hambourg", duration: 3600000, baseReward: 850, baseXP: 42, requiredXP: 60, unlocked: false }, // 1h
            { name: "üá∫üá∏ New York", duration: 10800000, baseReward: 2500, baseXP: 120, requiredXP: 200, unlocked: false }, // 3h
            { name: "üáßüá∑ Santos", duration: 18000000, baseReward: 4000, baseXP: 200, requiredXP: 400, unlocked: false }, // 5h
            { name: "üáØüáµ Tokyo", duration: 36000000, baseReward: 8000, baseXP: 400, requiredXP: 800, unlocked: false }, // 10h
            { name: "üá∏üá¨ Singapour", duration: 43200000, baseReward: 10000, baseXP: 500, requiredXP: 1200, unlocked: false }, // 12h
            { name: "üá¶üá∫ Sydney", duration: 43200000, baseReward: 12000, baseXP: 600, requiredXP: 1500, unlocked: false } // 12h
        ];

        // Destinations passagers (croisi√®res touristiques)
        const passengerDestinations = [
            { name: "üèñÔ∏è C√¥te d'Azur", duration: 300000, baseReward: 300, baseXP: 12, requiredXP: 0, unlocked: true }, // 5 min
            { name: "üèùÔ∏è √éles Anglo-Normandes", duration: 300000, baseReward: 350, baseXP: 15, requiredXP: 0, unlocked: true }, // 5 min
            { name: "üåÖ Fjords Norv√©giens", duration: 3600000, baseReward: 1200, baseXP: 50, requiredXP: 30, unlocked: false }, // 1h
            { name: "üèõÔ∏è √éles Grecques", duration: 3600000, baseReward: 1300, baseXP: 55, requiredXP: 60, unlocked: false }, // 1h
            { name: "üèùÔ∏è Bal√©ares", duration: 3600000, baseReward: 1100, baseXP: 45, requiredXP: 40, unlocked: false }, // 1h
            { name: "üóΩ Croisi√®re Transatlantique", duration: 10800000, baseReward: 4000, baseXP: 150, requiredXP: 150, unlocked: false }, // 3h
            { name: "üèñÔ∏è Cara√Øbes", duration: 18000000, baseReward: 6500, baseXP: 250, requiredXP: 300, unlocked: false }, // 5h
            { name: "üå∏ Croisi√®re Asie", duration: 36000000, baseReward: 12000, baseXP: 450, requiredXP: 600, unlocked: false }, // 10h
            { name: "üê® Tour du Pacifique", duration: 43200000, baseReward: 15000, baseXP: 550, requiredXP: 1000, unlocked: false }, // 12h
            { name: "üåç Tour du Monde", duration: 43200000, baseReward: 18000, baseXP: 700, requiredXP: 1800, unlocked: false } // 12h
        ];

        // Types de navires cargo √† acheter
        const cargoShipTypes = [
            { name: "Petit Cargo", cost: 5000, capacity: 80, level: 1, type: "cargo" },
            { name: "Cargo Moyen", cost: 15000, capacity: 150, level: 1, type: "cargo" },
            { name: "Grand Cargo", cost: 40000, capacity: 300, level: 1, type: "cargo" },
            { name: "Porte-conteneurs", cost: 100000, capacity: 500, level: 1, type: "cargo" }
        ];

        // Types de navires passagers √† acheter
        const passengerShipTypes = [
            { name: "Ferry C√¥tier", cost: 8000, capacity: 200, level: 1, type: "passenger" },
            { name: "Bateau de Croisi√®re", cost: 25000, capacity: 400, level: 1, type: "passenger" },
            { name: "Paquebot Moderne", cost: 60000, capacity: 800, level: 1, type: "passenger" },
            { name: "M√©ga Croisi√®re", cost: 150000, capacity: 1500, level: 1, type: "passenger" }
        ];

        // Missions sp√©cifiques par destination
        const specificMissions = {
            cargo: {
                "üá´üá∑ Le Havre": [
                    { cargo: "Charbon", quantity: 20, unit: "tonnes", reward: 300, description: "Livrer du charbon pour la centrale √©lectrique" },
                    { cargo: "Conteneurs", quantity: 15, unit: "conteneurs", reward: 250, description: "Transport de conteneurs manufactur√©s" },
                    { cargo: "C√©r√©ales", quantity: 35, unit: "tonnes", reward: 400, description: "Bl√© canadien pour les boulangeries fran√ßaises" }
                ],
                "üá≥üá± Rotterdam": [
                    { cargo: "P√©trole brut", quantity: 50, unit: "tonnes", reward: 500, description: "Approvisionnement de la raffinerie Shell" },
                    { cargo: "Produits chimiques", quantity: 12, unit: "tonnes", reward: 450, description: "Transport de produits industriels" },
                    { cargo: "Machines", quantity: 8, unit: "machines", reward: 600, description: "√âquipement lourd pour l'industrie" }
                ],
                "üá¨üáß Londres": [
                    { cargo: "Th√©", quantity: 5, unit: "tonnes", reward: 350, description: "Th√© de Ceylan pour les salons londoniens" },
                    { cargo: "Voitures", quantity: 25, unit: "v√©hicules", reward: 800, description: "V√©hicules allemands pour le march√© britannique" },
                    { cargo: "Textile", quantity: 18, unit: "tonnes", reward: 420, description: "Tissus pour l'industrie de la mode" }
                ],
                "üá™üá∏ Barcelone": [
                    { cargo: "Vin", quantity: 30, unit: "tonnes", reward: 1200, description: "Vin fran√ßais premium pour les restaurants" },
                    { cargo: "Marbre", quantity: 45, unit: "tonnes", reward: 1500, description: "Marbre italien pour la construction" },
                    { cargo: "√âlectronique", quantity: 12, unit: "palettes", reward: 1000, description: "Composants high-tech asiatiques" }
                ],
                "üáÆüáπ G√™nes": [
                    { cargo: "P√¢tes", quantity: 25, unit: "tonnes", reward: 1100, description: "P√¢tes artisanales pour l'export" },
                    { cargo: "Ferraille", quantity: 60, unit: "tonnes", reward: 1400, description: "Recyclage m√©tallique pour les aci√©ries" },
                    { cargo: "Huile d'olive", quantity: 15, unit: "tonnes", reward: 1300, description: "Huile d'olive extra vierge toscane" }
                ],
                "üá©üá™ Hambourg": [
                    { cargo: "Automobiles", quantity: 40, unit: "v√©hicules", reward: 1600, description: "Export d'automobiles allemandes" },
                    { cargo: "Bi√®re", quantity: 50, unit: "tonnes", reward: 1200, description: "Bi√®re allemande artisanale" },
                    { cargo: "√âquipements industriels", quantity: 15, unit: "machines", reward: 1800, description: "Machines-outils de pr√©cision" }
                ],
                "üá∫üá∏ New York": [
                    { cargo: "Conteneurs de luxe", quantity: 80, unit: "conteneurs", reward: 4000, description: "Produits de luxe europ√©ens pour Manhattan" },
                    { cargo: "Mati√®res premi√®res", quantity: 120, unit: "tonnes", reward: 3500, description: "Acier et aluminium pour la construction" },
                    { cargo: "Technologie", quantity: 25, unit: "palettes", reward: 5000, description: "Composants √©lectroniques avanc√©s" }
                ],
                "üáßüá∑ Santos": [
                    { cargo: "Caf√©", quantity: 100, unit: "tonnes", reward: 6000, description: "Caf√© br√©silien premium pour l'Europe" },
                    { cargo: "Minerai de fer", quantity: 200, unit: "tonnes", reward: 5500, description: "Minerai pour les aci√©ries europ√©ennes" },
                    { cargo: "Produits agricoles", quantity: 150, unit: "tonnes", reward: 4800, description: "Soja et c√©r√©ales pour l'export" }
                ],
                "üáØüáµ Tokyo": [
                    { cargo: "√âlectronique japonaise", quantity: 60, unit: "conteneurs", reward: 12000, description: "Technologies de pointe made in Japan" },
                    { cargo: "Automobiles", quantity: 100, unit: "v√©hicules", reward: 15000, description: "Voitures japonaises pour l'Europe" },
                    { cargo: "Composants industriels", quantity: 40, unit: "palettes", reward: 10000, description: "Pi√®ces de haute pr√©cision" }
                ],
                "üá∏üá¨ Singapour": [
                    { cargo: "√âpices et aromates", quantity: 80, unit: "tonnes", reward: 14000, description: "√âpices exotiques d'Asie du Sud-Est" },
                    { cargo: "Produits technologiques", quantity: 50, unit: "conteneurs", reward: 16000, description: "Hub technologique asiatique" },
                    { cargo: "P√©trole raffin√©", quantity: 120, unit: "tonnes", reward: 13000, description: "Carburants raffin√©s de Singapour" }
                ],
                "üá¶üá∫ Sydney": [
                    { cargo: "Minerais pr√©cieux", quantity: 150, unit: "tonnes", reward: 18000, description: "Or et m√©taux rares australiens" },
                    { cargo: "Produits agricoles", quantity: 200, unit: "tonnes", reward: 15000, description: "Bl√© et b≈ìuf australiens" },
                    { cargo: "Laine premium", quantity: 100, unit: "tonnes", reward: 16000, description: "Laine merinos de qualit√© sup√©rieure" }
                ]
            },
            passenger: {
                "üèñÔ∏è C√¥te d'Azur": [
                    { passengers: 120, type: "Familles", reward: 450, description: "Familles en vacances d'√©t√© √† Nice et Cannes" },
                    { passengers: 80, type: "Couples", reward: 500, description: "Escapade romantique sur la Riviera fran√ßaise" },
                    { passengers: 200, type: "Touristes", reward: 600, description: "Circuit touristique de la M√©diterran√©e" }
                ],
                "üèùÔ∏è √éles Anglo-Normandes": [
                    { passengers: 150, type: "Randonneurs", reward: 400, description: "Groupe de randonneurs pour Jersey et Guernesey" },
                    { passengers: 90, type: "Photographes", reward: 520, description: "Exp√©dition photo nature des √Æles britanniques" },
                    { passengers: 110, type: "Familles", reward: 380, description: "D√©couverte des traditions anglo-normandes" }
                ],
                "üåÖ Fjords Norv√©giens": [
                    { passengers: 300, type: "Croisi√©ristes", reward: 1800, description: "Croisi√®re panoramique des fjords spectaculaires" },
                    { passengers: 180, type: "Aventuriers", reward: 1600, description: "Exp√©dition kayak et randonn√©e en Norv√®ge" },
                    { passengers: 250, type: "Seniors", reward: 1900, description: "Voyage culturel pour seniors actifs" }
                ],
                "üèõÔ∏è √éles Grecques": [
                    { passengers: 220, type: "Jeunes", reward: 1500, description: "Voyage √©tudiant d√©couverte de la Gr√®ce antique" },
                    { passengers: 160, type: "Couples", reward: 1700, description: "Lune de miel dans les Cyclades" },
                    { passengers: 350, type: "Croisi√©ristes", reward: 2000, description: "Circuit complet Santorin-Mykonos-Rhodes" }
                ],
                "üèùÔ∏è Bal√©ares": [
                    { passengers: 280, type: "F√™tards", reward: 1400, description: "Soir√©es √† Ibiza et Majorque" },
                    { passengers: 200, type: "Familles", reward: 1600, description: "Vacances familiales aux Bal√©ares" },
                    { passengers: 150, type: "Couples", reward: 1800, description: "Escapade romantique m√©diterran√©enne" }
                ],
                "üóΩ Croisi√®re Transatlantique": [
                    { passengers: 500, type: "Croisi√©ristes de luxe", reward: 6000, description: "Travers√©e transatlantique de prestige" },
                    { passengers: 300, type: "Businessmen", reward: 5500, description: "Hommes d'affaires en voyage d'affaires" },
                    { passengers: 400, type: "Retrait√©s", reward: 6500, description: "Croisi√®re tranquille pour seniors fortun√©s" }
                ],
                "üèñÔ∏è Cara√Øbes": [
                    { passengers: 600, type: "Vacanciers", reward: 8500, description: "Vacances tropicales aux Cara√Øbes" },
                    { passengers: 400, type: "Plongeurs", reward: 9000, description: "Exp√©dition plong√©e dans les r√©cifs coralliens" },
                    { passengers: 350, type: "Lunes de miel", reward: 10000, description: "Voyages de noces dans les √Æles paradisiaques" }
                ],
                "üå∏ Croisi√®re Asie": [
                    { passengers: 700, type: "Explorateurs", reward: 15000, description: "D√©couverte culturelle de l'Asie" },
                    { passengers: 500, type: "Photographes", reward: 16000, description: "Safari photo en Asie du Sud-Est" },
                    { passengers: 600, type: "Gastronomes", reward: 14000, description: "Tour culinaire des capitales asiatiques" }
                ],
                "üê® Tour du Pacifique": [
                    { passengers: 800, type: "Aventuriers", reward: 20000, description: "Exp√©dition dans les √Æles du Pacifique" },
                    { passengers: 600, type: "Naturalistes", reward: 22000, description: "Observation de la faune du Pacifique" },
                    { passengers: 700, type: "Retrait√©s fortun√©s", reward: 25000, description: "Croisi√®re de luxe dans le Pacifique" }
                ],
                "üåç Tour du Monde": [
                    { passengers: 1000, type: "Milliardaires", reward: 35000, description: "Tour du monde en navire de luxe" },
                    { passengers: 800, type: "C√©l√©brit√©s", reward: 40000, description: "Croisi√®re VIP tour du monde" },
                    { passengers: 900, type: "Explorateurs", reward: 30000, description: "Exp√©dition scientifique mondiale" }
                ]
            }
        };

        // √âtat du jeu
        let gameState = {
            money: 10000,
            xp: 0,
            savings: 0,
            debt: 0,
            passiveIncome: 0,
            portLevel: 1,
            cargoShips: [
                { id: 1, name: "Cargo Express", level: 1, capacity: 100, onMission: false, missionEnd: 0, destination: null, type: "cargo" }
            ],
            passengerShips: [
                { id: 2, name: "Ferry Starter", level: 1, capacity: 150, onMission: false, missionEnd: 0, destination: null, type: "passenger" }
            ],
            missions: [],
            loanInterestRate: 0.05, // 5% par heure (au lieu de 1% par minute)
            savingsInterestRate: 0.02, // 2% par heure (au lieu de 0.5% par minute)
            lastSave: Date.now(),
            currentFleetTab: "cargo",
            lastDailyReward: 0, // Timestamp de la derni√®re r√©compense quotidienne
            dailyRewardStreak: 0, // S√©rie de jours cons√©cutifs
            lastMissionRefresh: 0 // Timestamp du dernier renouvellement automatique des missions
        };

        function updateDisplay() {
            document.getElementById('money').textContent = Math.floor(gameState.money).toLocaleString();
            document.getElementById('xp').textContent = gameState.xp.toLocaleString();
            document.getElementById('savings').textContent = Math.floor(gameState.savings).toLocaleString();
            document.getElementById('debt').textContent = Math.floor(gameState.debt).toLocaleString();
            document.getElementById('passive-income').textContent = Math.floor(gameState.passiveIncome).toLocaleString();
            
            // Mettre √† jour la r√©compense quotidienne sur la page principale
            updateMainDailyRewardDisplay();
        }

        function updateMainDailyRewardDisplay() {
            const dailyRewardInfo = document.getElementById('main-daily-reward-info');
            if (!dailyRewardInfo) return;
            
            const now = Date.now();
            const rewardCooldown = 24 * 60 * 60 * 1000; // 24 heures r√©elles
            
            const timeSinceLastReward = now - gameState.lastDailyReward;
            const canClaim = timeSinceLastReward >= rewardCooldown;
            
            if (canClaim) {
                const baseReward = 1000;
                const streakBonus = gameState.dailyRewardStreak * 500;
                const totalReward = baseReward + streakBonus;
                
                dailyRewardInfo.innerHTML = `
                    <div>
                        <p>üéÅ <strong>R√©compense disponible !</strong></p>
                        <p>R√©compense de base: ${baseReward.toLocaleString()}‚Ç¨</p>
                        <p>Bonus s√©rie (${gameState.dailyRewardStreak} jours): ${streakBonus.toLocaleString()}‚Ç¨</p>
                        <p style="font-size: 1.2em; font-weight: bold; color: #FFC107; margin: 10px 0;">
                            Total: ${totalReward.toLocaleString()}‚Ç¨
                        </p>
                        <button class="bank-btn" onclick="claimDailyReward()" style="background: #FFC107; color: #000; font-weight: bold;">
                            üéÅ R√©cup√©rer la r√©compense !
                        </button>
                    </div>
                `;
            } else {
                const timeLeft = rewardCooldown - timeSinceLastReward;
                const hoursLeft = Math.floor(timeLeft / (60 * 60 * 1000));
                const minutesLeft = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
                const secondsLeft = Math.floor((timeLeft % (60 * 1000)) / 1000);
                
                dailyRewardInfo.innerHTML = `
                    <div>
                        <p>‚è∞ Prochaine r√©compense dans:</p>
                        <p style="font-size: 1.5em; font-weight: bold; color: #FFC107; margin: 10px 0;">
                            ${hoursLeft.toString().padStart(2, '0')}:${minutesLeft.toString().padStart(2, '0')}:${secondsLeft.toString().padStart(2, '0')}
                        </p>
                        <p>S√©rie actuelle: ${gameState.dailyRewardStreak} jours</p>
                        <p>Prochaine r√©compense: ${(1000 + (gameState.dailyRewardStreak + 1) * 500).toLocaleString()}‚Ç¨</p>
                    </div>
                `;
            }
        }

        function claimDailyReward() {
            const baseReward = 1000;
            const streakBonus = gameState.dailyRewardStreak * 500;
            const totalReward = baseReward + streakBonus;
            
            gameState.money += totalReward;
            gameState.lastDailyReward = Date.now();
            gameState.dailyRewardStreak += 1;
            
            // Son de r√©compense quotidienne
            audioManager.playSound('daily_reward');
            
            showNotification(`üéÅ R√©compense quotidienne r√©cup√©r√©e ! +${totalReward.toLocaleString()}‚Ç¨ (S√©rie: ${gameState.dailyRewardStreak} jours)`, '#FFC107');
            
            updateDisplay();
            updateBankDisplay();
            saveGame();
        }

        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenName + '-screen').classList.add('active');
            
            if (screenName === 'fleet') {
                updateFleetDisplay();
            }
            if (screenName === 'shop') {
                updateShopDisplay();
            }
            if (screenName === 'bank') {
                updateBankDisplay();
            }
        }

        function switchFleetTab(tabType) {
            gameState.currentFleetTab = tabType;
            
            // Mettre √† jour les onglets visuellement
            document.querySelectorAll('.fleet-tab').forEach(tab => tab.classList.remove('active'));
            
            // Trouver l'onglet correspondant et l'activer
            const tabs = document.querySelectorAll('.fleet-tab');
            tabs.forEach(tab => {
                if ((tabType === 'cargo' && tab.textContent.includes('Cargo')) || 
                    (tabType === 'passenger' && tab.textContent.includes('Passagers'))) {
                    tab.classList.add('active');
                }
            });
            
            // Mettre √† jour les titres
            const isCargoTab = tabType === 'cargo';
            document.getElementById('fleet-ships-title').textContent = isCargoTab ? 'Vos Navires Cargo' : 'Vos Navires Passagers';
            document.getElementById('fleet-destinations-title').textContent = isCargoTab ? 'Destinations Cargo' : 'Destinations Touristiques';
            
            // Rafra√Æchir l'affichage
            updateFleetDisplay();
        }

        function updateFleetDisplay() {
            const shipsList = document.getElementById('ships-list');
            const destinationsList = document.getElementById('destinations-list');
            
            // Mettre √† jour l'indicateur de renouvellement des missions
            updateMissionRefreshInfo();
            
            const isCargoTab = gameState.currentFleetTab === 'cargo';
            const ships = isCargoTab ? gameState.cargoShips : gameState.passengerShips;
            const destinations = isCargoTab ? cargoDestinations : passengerDestinations;
            const shipIcon = isCargoTab ? 'üö¢' : 'üõ≥Ô∏è';
            const capacityUnit = isCargoTab ? 'tonnes' : 'passagers';
            
            // Afficher les navires
            shipsList.innerHTML = ships.map(ship => {
                const isOnMission = ship.onMission && Date.now() < ship.missionEnd;
                const timeLeft = isOnMission ? Math.ceil((ship.missionEnd - Date.now()) / 1000) : 0;
                const destinationForShip = destinations.find(d => d.name === ship.destination);
                const totalDuration = destinationForShip ? destinationForShip.duration : 0;
                const progress = isOnMission && totalDuration > 0 ? 100 - ((timeLeft * 1000) / totalDuration) * 100 : 0;
                
                let missionDetails = '';
                if (isOnMission && ship.currentMission) {
                    const mission = ship.currentMission;
                    if (gameState.currentFleetTab === 'cargo') {
                        missionDetails = `Transport: ${mission.cargo} (${mission.quantity} ${mission.unit})`;
                    } else {
                        missionDetails = `Transport: ${mission.passengers} ${mission.type}`;
                    }
                }
                
                return `
                    <div class="ship-card">
                        <h4>${shipIcon} ${ship.name} (Niveau ${ship.level})</h4>
                        <p>Capacit√©: ${ship.capacity * ship.level} ${capacityUnit}</p>
                        ${isOnMission ? 
                            `<p>üö¢ ${missionDetails || 'En mission'} ‚Üí ${ship.destination}</p>
                             <p>‚è±Ô∏è ${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2, '0')} restantes</p>
                             <div class="progress-bar">
                                <div class="progress-waves"></div>
                                <div class="progress-ship" style="left: ${Math.max(0, Math.min(95, progress))}%">${shipIcon}</div>
                             </div>` : 
                            '<p>‚úÖ Disponible</p>'}
                    </div>
                `;
            }).join('');
            
            // Afficher les destinations avec missions propos√©es
            destinationsList.innerHTML = destinations.map((dest, index) => {
                const isUnlocked = dest.unlocked;
                const availableShip = ships.find(ship => !ship.onMission || Date.now() >= ship.missionEnd);
                const hasAvailableShip = !!availableShip;
                
                if (!isUnlocked) {
                    return `
                        <div class="destination-card locked">
                            <h4>${dest.name} üîí</h4>
                            <p>‚è±Ô∏è Dur√©e: ${formatDuration(dest.duration)}</p>
                            <p>üí∞ R√©compense: ${Math.floor(dest.baseReward * gameState.portLevel)}‚Ç¨</p>
                            <p>‚≠ê XP: ${dest.baseXP}</p>
                            <p class="xp-requirement">üîí Requis: ${dest.requiredXP} XP</p>
                        </div>
                    `;
                }
                
                // G√©n√©rer une mission al√©atoire pour cette destination
                const missions = specificMissions[gameState.currentFleetTab][dest.name] || [];
                let missionHtml = '';
                
                if (hasAvailableShip && missions.length > 0) {
                    // Choisir une mission al√©atoire (mais stable pour cette destination)
                    const seed = dest.lastRefresh || dest.name.length;
                    const missionIndex = Math.abs(seed + Math.floor(Date.now() / 600000)) % missions.length;
                    const mission = missions[Math.floor(missionIndex)];
                    
                    const costs = calculateMissionCosts(availableShip, dest, gameState.currentFleetTab);
                    const canAfford = gameState.money >= costs.total;
                    
                    // V√©rifier si le navire a assez de capacit√©
                    const requiredCapacity = gameState.currentFleetTab === 'cargo' ? mission.quantity : mission.passengers;
                    const shipCapacity = availableShip.capacity * availableShip.level;
                    const hasCapacity = shipCapacity >= requiredCapacity;
                    
                    const finalReward = mission.reward * gameState.portLevel;
                    
                    missionHtml = `
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid ${hasCapacity && canAfford ? '#4CAF50' : '#ff6b6b'};">
                            <div style="background: rgba(33, 150, 243, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                <p style="font-weight: bold; color: #2196F3; margin-bottom: 5px;">üì¢ Mission Propos√©e</p>
                                <p style="font-size: 0.95em;">
                                    <strong>${dest.name}</strong> vous propose de ${gameState.currentFleetTab === 'cargo' ? 
                                        `livrer <strong>${mission.quantity} ${mission.unit} de ${mission.cargo}</strong>` : 
                                        `transporter <strong>${mission.passengers} ${mission.type}</strong>`}
                                </p>
                                <p style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">${mission.description}</p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; font-size: 0.9em;">
                                <div>üí∞ Gain: <strong>${finalReward}‚Ç¨</strong></div>
                                <div>‚≠ê XP: <strong>${dest.baseXP}</strong></div>
                                <div>üí∏ Co√ªt: <strong>${costs.total}‚Ç¨</strong></div>
                                <div>‚è±Ô∏è Dur√©e: <strong>${formatDuration(dest.duration)}</strong></div>
                            </div>
                            
                            ${!hasCapacity ? 
                                `<p style="font-size: 0.85em; color: #ff6b6b; margin: 5px 0;">‚ùå Capacit√© insuffisante ! Navire: ${shipCapacity}, Requis: ${requiredCapacity}</p>` : ''}
                            ${!canAfford ? 
                                `<p style="font-size: 0.85em; color: #ff9800; margin: 5px 0;">üí∏ Fonds insuffisants !</p>` : ''}
                            
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="mission-btn" onclick="startSpecificMission(${index}, ${Math.floor(missionIndex)}, '${gameState.currentFleetTab}')" 
                                    style="flex: 1;" ${!canAfford || !hasCapacity ? 'disabled' : ''}>
                                    ${!hasCapacity ? '‚ùå Navire trop petit' : !canAfford ? '‚ùå Pas assez d\'argent' : '‚úÖ Accepter la mission'}
                                </button>
                                <button class="mission-btn" onclick="refreshMission(${index})" 
                                    style="background: #FF9800; flex: 0 0 auto; padding: 8px 12px;">
                                    üîÑ
                                </button>
                            </div>
                        </div>
                    `;
                } else if (hasAvailableShip) {
                    missionHtml = `
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center; opacity: 0.7;">
                            <p>üòî Aucune mission disponible actuellement</p>
                            <p style="font-size: 0.9em; margin-top: 5px;">Revenez plus tard !</p>
                        </div>
                    `;
                } else {
                    missionHtml = `
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center; opacity: 0.7;">
                            <p>üö¢ Aucun navire disponible</p>
                            <p style="font-size: 0.9em; margin-top: 5px;">Attendez qu'un navire revienne de mission</p>
                        </div>
                    `;
                }
                
                return `
                    <div class="destination-card">
                        <h4>${dest.name}</h4>
                        ${missionHtml}
                    </div>
                `;
            }).join('');
        }

        function calculateMissionCosts(ship, destination, shipType) {
            // Co√ªt de carburant (d√©pend de la dur√©e et du type)
            const fuelCost = Math.floor(destination.duration / 60000) * (shipType === 'cargo' ? 10 : 15);
            
            // Frais d'entretien (d√©pend du niveau et de la capacit√© du navire)
            const maintenanceCost = Math.floor((ship.level * ship.capacity) / 10) * (shipType === 'cargo' ? 2 : 3);
            
            // Frais d'assurance (d√©pend de la distance/dur√©e et du type de navire)
            const insuranceBaseCost = shipType === 'cargo' ? 50 : 80;
            const insuranceCost = Math.floor(insuranceBaseCost + (destination.duration / 3600000) * 25); // +25‚Ç¨ par heure
            
            return {
                fuel: fuelCost,
                maintenance: maintenanceCost,
                insurance: insuranceCost,
                total: fuelCost + maintenanceCost + insuranceCost
            };
        }

        function calculateMissionRisk(ship, mission, portLevel) {
            let baseRisk = mission.risk;
            
            // R√©duction de risque par niveau du navire (2% par niveau)
            const shipLevelReduction = (ship.level - 1) * 2;
            
            // R√©duction de risque par niveau du port (1% par niveau apr√®s le niveau 1)
            const portLevelReduction = Math.max(0, portLevel - 1) * 1;
            
            // Calcul du risque final
            const finalRisk = Math.max(0, baseRisk - shipLevelReduction - portLevelReduction);
            
            return {
                baseRisk: baseRisk,
                shipReduction: shipLevelReduction,
                portReduction: portLevelReduction,
                finalRisk: finalRisk
            };
        }

        function calculateMissionReward(ship, destination, mission, portLevel) {
            const baseReward = Math.floor(destination.baseReward * portLevel * (ship.capacity * ship.level / 100));
            return Math.floor(baseReward * mission.rewardMultiplier);
        }

        function startSpecificMission(destinationIndex, missionIndex, shipType) {
            const destinations = shipType === 'cargo' ? cargoDestinations : passengerDestinations;
            const ships = shipType === 'cargo' ? gameState.cargoShips : gameState.passengerShips;
            
            const destination = destinations[destinationIndex];
            const missions = specificMissions[shipType][destination.name] || [];
            const mission = missions[missionIndex];
            
            if (!destination || !destination.unlocked || !mission) {
                audioManager.playSound('error');
                showNotification('Mission non disponible !', '#ff6b6b');
                return;
            }
            
            const availableShip = ships.find(ship => !ship.onMission || Date.now() >= ship.missionEnd);
            
            if (!availableShip) {
                audioManager.playSound('error');
                showNotification('Aucun navire disponible !', '#ff6b6b');
                return;
            }
            
            // V√©rifier la capacit√©
            const requiredCapacity = shipType === 'cargo' ? mission.quantity : mission.passengers;
            const shipCapacity = availableShip.capacity * availableShip.level;
            
            if (shipCapacity < requiredCapacity) {
                audioManager.playSound('error');
                showNotification(`Capacit√© insuffisante ! Navire: ${shipCapacity}, Requis: ${requiredCapacity}`, '#ff6b6b');
                return;
            }
            
            // Calculer tous les co√ªts
            const costs = calculateMissionCosts(availableShip, destination, shipType);
            
            if (gameState.money < costs.total) {
                audioManager.playSound('error');
                showNotification(`Fonds insuffisants ! Co√ªt total: ${costs.total}‚Ç¨`, '#ff6b6b');
                return;
            }
            
            // D√©duire tous les co√ªts
            gameState.money -= costs.total;
            availableShip.onMission = true;
            availableShip.missionEnd = Date.now() + destination.duration;
            availableShip.destination = destination.name;
            availableShip.currentMission = mission;
            availableShip.missionDestinationIndex = destinationIndex;
            
            // Programmer la fin de mission
            setTimeout(() => {
                if (availableShip.onMission && availableShip.destination === destination.name) {
                    completeMissionWithResults(availableShip);
                }
            }, destination.duration);
            
            const shipIcon = shipType === 'cargo' ? 'üö¢' : 'üõ≥Ô∏è';
            const cargoInfo = shipType === 'cargo' ? 
                `${mission.cargo} (${mission.quantity} ${mission.unit})` : 
                `${mission.passengers} ${mission.type}`;
            
            // Son de d√©part de navire
            audioManager.playSound('ship_departure');
            
            showNotification(`${shipIcon} ${availableShip.name} parti avec ${cargoInfo} vers ${destination.name} !`, '#2196F3');
            updateDisplay();
            updateFleetDisplay();
            saveGame();
        }

        function completeMissionWithResults(ship) {
            const destinations = ship.type === "cargo" ? cargoDestinations : passengerDestinations;
            const destination = destinations.find(d => d.name === ship.destination);
            const mission = ship.currentMission;
            
            if (destination && mission) {
                // Missions sp√©cifiques - pas de risque, r√©compense directe
                const finalReward = mission.reward * gameState.portLevel;
                const xpReward = destination.baseXP;
                
                gameState.money += finalReward;
                gameState.xp += xpReward;
                
                const shipType = ship.type === "cargo" ? "üö¢" : "üõ≥Ô∏è";
                const cargoInfo = ship.type === "cargo" ? 
                    `${mission.cargo} (${mission.quantity} ${mission.unit})` : 
                    `${mission.passengers} ${mission.type}`;
                
                // Son de mission r√©ussie
                audioManager.playSound('mission_success');
                
                showNotification(`${shipType} ${ship.name} : Livraison r√©ussie ! ${cargoInfo} - +${finalReward}‚Ç¨ +${xpReward}XP`, '#4CAF50');
                
                ship.onMission = false;
                ship.destination = null;
                ship.missionEnd = 0;
                ship.currentMission = null;
                ship.missionDestinationIndex = null;
                
                updateUnlockedDestinations();
                updateDisplay();
                
                // Sauvegarder automatiquement
                saveGame();
            }
        }

        function startMission(destinationName, shipType) {
            // Fonction de compatibilit√© - utilise la premi√®re mission disponible
            const destinations = shipType === 'cargo' ? cargoDestinations : passengerDestinations;
            const destinationIndex = destinations.findIndex(d => d.name === destinationName);
            
            if (destinationIndex !== -1) {
                startSpecificMission(destinationIndex, 0, shipType); // Utilise la premi√®re mission (standard)
            }
        }

        function startMissionByIndex(destinationIndex, shipType) {
            // Fonction de compatibilit√©
            startSpecificMission(destinationIndex, 0, shipType);
        }

        function refreshMission(destinationIndex) {
            // Ajouter un timestamp pour forcer le changement de mission
            const destinations = gameState.currentFleetTab === 'cargo' ? cargoDestinations : passengerDestinations;
            const dest = destinations[destinationIndex];
            
            // Utiliser un timestamp pour forcer une nouvelle mission al√©atoire
            dest.lastRefresh = Date.now();
            
            // Rafra√Æchir l'affichage
            updateFleetDisplay();
            
            showNotification(`üîÑ Nouvelle mission g√©n√©r√©e pour ${dest.name}`, '#FF9800');
        }

        function updateMissionRefreshInfo() {
            const missionRefreshInfo = document.getElementById('mission-refresh-info');
            if (!missionRefreshInfo) return;
            
            const now = Date.now();
            const missionRefreshInterval = 10 * 60 * 1000; // 10 minutes
            const timeSinceLastRefresh = now - (gameState.lastMissionRefresh || 0);
            const timeUntilNextRefresh = missionRefreshInterval - timeSinceLastRefresh;
            
            if (timeUntilNextRefresh <= 0) {
                missionRefreshInfo.innerHTML = `
                    <span style="color: #4CAF50; font-weight: bold;">
                        ‚ú® Nouvelles missions disponibles ! 
                        <button onclick="manualRefreshAllMissions()" style="background: #4CAF50; border: none; color: white; padding: 5px 10px; border-radius: 5px; margin-left: 10px; cursor: pointer;">
                            üîÑ Actualiser
                        </button>
                    </span>
                `;
            } else {
                const minutesLeft = Math.floor(timeUntilNextRefresh / (60 * 1000));
                const secondsLeft = Math.floor((timeUntilNextRefresh % (60 * 1000)) / 1000);
                
                missionRefreshInfo.innerHTML = `
                    üîÑ Renouvellement automatique des missions dans : 
                    <strong style="color: #FF9800;">
                        ${minutesLeft.toString().padStart(2, '0')}:${secondsLeft.toString().padStart(2, '0')}
                    </strong>
                    <span style="font-size: 0.8em; opacity: 0.7; margin-left: 10px;">
                        (ou utilisez le bouton üîÑ sur chaque mission)
                    </span>
                `;
            }
        }

        function manualRefreshAllMissions() {
            const now = Date.now();
            gameState.lastMissionRefresh = now;
            
            // Renouveler toutes les missions
            [...cargoDestinations, ...passengerDestinations].forEach(dest => {
                dest.lastRefresh = now;
            });
            
            updateFleetDisplay();
            showNotification('üîÑ Toutes les missions ont √©t√© renouvel√©es !', '#4CAF50');
        }

        function updateShopDisplay() {
            const portUpgrades = document.getElementById('port-upgrades');
            const cargoShipUpgrades = document.getElementById('cargo-ship-upgrades');
            const passengerShipUpgrades = document.getElementById('passenger-ship-upgrades');
            const newCargoShips = document.getElementById('new-cargo-ships');
            const newPassengerShips = document.getElementById('new-passenger-ships');
            
            // Am√©liorations du port
            const portUpgradeCost = gameState.portLevel * 10000;
            portUpgrades.innerHTML = `
                <div class="upgrade-card">
                    <h4>üèóÔ∏è Port Niveau ${gameState.portLevel}</h4>
                    <p>Am√©lioration: Niveau ${gameState.portLevel + 1}</p>
                    <p>Co√ªt: ${portUpgradeCost.toLocaleString()}‚Ç¨</p>
                    <p>Bonus: +${gameState.portLevel * 10}% revenus missions</p>
                    <button class="upgrade-btn" onclick="upgradePort()" ${gameState.money < portUpgradeCost ? 'disabled' : ''}>
                        Am√©liorer Port
                    </button>
                </div>
            `;
            
            // Am√©liorations des navires cargo
            cargoShipUpgrades.innerHTML = gameState.cargoShips.map(ship => {
                const upgradeCost = ship.level * 2000;
                const currentMaintenanceCost = Math.floor((ship.level * ship.capacity) / 10) * 2;
                const newMaintenanceCost = Math.floor(((ship.level + 1) * ship.capacity) / 10) * 2;
                const currentRiskReduction = (ship.level - 1) * 2;
                const newRiskReduction = ship.level * 2;
                
                return `
                    <div class="upgrade-card">
                        <h4>üö¢ ${ship.name} (Niveau ${ship.level})</h4>
                        <p>Capacit√© actuelle: ${ship.capacity * ship.level} tonnes</p>
                        <p>Co√ªt entretien actuel: ${currentMaintenanceCost}‚Ç¨ par mission</p>
                        <p style="color: #4CAF50;">üõ°Ô∏è R√©duction risque actuelle: -${currentRiskReduction}%</p>
                        <hr style="margin: 10px 0; border: 0; border-top: 1px solid rgba(255,255,255,0.2);">
                        <p>Co√ªt am√©lioration: ${upgradeCost.toLocaleString()}‚Ç¨</p>
                        <p>Nouvelle capacit√©: ${ship.capacity * (ship.level + 1)} tonnes</p>
                        <p>Nouvel entretien: ${newMaintenanceCost}‚Ç¨ par mission</p>
                        <p style="color: #4CAF50; font-weight: bold;">üõ°Ô∏è Nouvelle r√©duction risque: -${newRiskReduction}%</p>
                        <button class="upgrade-btn" onclick="upgradeShip(${ship.id}, 'cargo')" ${gameState.money < upgradeCost ? 'disabled' : ''}>
                            Am√©liorer
                        </button>
                    </div>
                `;
            }).join('');
            
            // Am√©liorations des navires passagers
            passengerShipUpgrades.innerHTML = gameState.passengerShips.map(ship => {
                const upgradeCost = ship.level * 2500;
                const currentMaintenanceCost = Math.floor((ship.level * ship.capacity) / 10) * 3;
                const newMaintenanceCost = Math.floor(((ship.level + 1) * ship.capacity) / 10) * 3;
                
                return `
                    <div class="upgrade-card">
                        <h4>üõ≥Ô∏è ${ship.name} (Niveau ${ship.level})</h4>
                        <p>Capacit√© actuelle: ${ship.capacity * ship.level} passagers</p>
                        <p>Co√ªt entretien actuel: ${currentMaintenanceCost}‚Ç¨ par mission</p>
                        <hr style="margin: 10px 0; border: 0; border-top: 1px solid rgba(255,255,255,0.2);">
                        <p>Co√ªt am√©lioration: ${upgradeCost.toLocaleString()}‚Ç¨</p>
                        <p>Nouvelle capacit√©: ${ship.capacity * (ship.level + 1)} passagers</p>
                        <p>Nouvel entretien: ${newMaintenanceCost}‚Ç¨ par mission</p>
                        <p style="color: #4CAF50; font-weight: bold;">üìà Plus de missions disponibles !</p>
                        <button class="upgrade-btn" onclick="upgradeShip(${ship.id}, 'passenger')" ${gameState.money < upgradeCost ? 'disabled' : ''}>
                            Am√©liorer
                        </button>
                    </div>
                `;
            }).join('');
            
            // Nouveaux navires cargo
            newCargoShips.innerHTML = cargoShipTypes.map((shipType, index) => {
                const maintenanceCost = Math.floor((shipType.level * shipType.capacity) / 10) * 2;
                
                return `
                    <div class="upgrade-card">
                        <h4>üö¢ ${shipType.name}</h4>
                        <p>Capacit√©: ${shipType.capacity} tonnes</p>
                        <p>Co√ªt entretien: ${maintenanceCost}‚Ç¨ par mission</p>
                        <p style="color: #4CAF50;">üì¶ Peut transporter plus de marchandises</p>
                        <p>Co√ªt d'achat: ${shipType.cost.toLocaleString()}‚Ç¨</p>
                        <button class="upgrade-btn" onclick="buyShip(${index}, 'cargo')" ${gameState.money < shipType.cost ? 'disabled' : ''}>
                            Acheter
                        </button>
                    </div>
                `;
            }).join('');
            
            // Nouveaux navires passagers
            newPassengerShips.innerHTML = passengerShipTypes.map((shipType, index) => {
                const maintenanceCost = Math.floor((shipType.level * shipType.capacity) / 10) * 3;
                
                return `
                    <div class="upgrade-card">
                        <h4>üõ≥Ô∏è ${shipType.name}</h4>
                        <p>Capacit√©: ${shipType.capacity} passagers</p>
                        <p>Co√ªt entretien: ${maintenanceCost}‚Ç¨ par mission</p>
                        <p style="color: #4CAF50;">üë• Peut accueillir plus de passagers</p>
                        <p>Co√ªt d'achat: ${shipType.cost.toLocaleString()}‚Ç¨</p>
                        <button class="upgrade-btn" onclick="buyShip(${index}, 'passenger')" ${gameState.money < shipType.cost ? 'disabled' : ''}>
                            Acheter
                        </button>
                    </div>
                `;
            }).join('');
        }

        function upgradePort() {
            const cost = gameState.portLevel * 10000;
            if (gameState.money >= cost) {
                gameState.money -= cost;
                gameState.portLevel++;
                
                // Son d'am√©lioration
                audioManager.playSound('upgrade');
                
                showNotification(`Port am√©lior√© ! Niveau ${gameState.portLevel}`, '#4CAF50');
                updateDisplay();
                updateShopDisplay();
                saveGame();
            } else {
                audioManager.playSound('error');
            }
        }

        function upgradeShip(shipId, shipType) {
            const ships = shipType === 'cargo' ? gameState.cargoShips : gameState.passengerShips;
            const ship = ships.find(s => s.id === shipId);
            const cost = ship.level * (shipType === 'cargo' ? 2000 : 2500);
            
            if (gameState.money >= cost) {
                gameState.money -= cost;
                ship.level++;
                const shipIcon = shipType === 'cargo' ? 'üö¢' : 'üõ≥Ô∏è';
                
                // Son d'am√©lioration
                audioManager.playSound('upgrade');
                
                showNotification(`${shipIcon} ${ship.name} am√©lior√© !`, '#4CAF50');
                updateDisplay();
                updateShopDisplay();
                saveGame();
            } else {
                audioManager.playSound('error');
            }
        }

        function buyShip(shipTypeIndex, shipCategory) {
            const shipTypes = shipCategory === 'cargo' ? cargoShipTypes : passengerShipTypes;
            const shipType = shipTypes[shipTypeIndex];
            
            if (gameState.money >= shipType.cost) {
                gameState.money -= shipType.cost;
                const ships = shipCategory === 'cargo' ? gameState.cargoShips : gameState.passengerShips;
                const shipIcon = shipCategory === 'cargo' ? 'üö¢' : 'üõ≥Ô∏è';
                
                const newShip = {
                    id: Date.now(),
                    name: shipType.name + ' #' + (ships.length + 1),
                    level: shipType.level,
                    capacity: shipType.capacity,
                    onMission: false,
                    missionEnd: 0,
                    destination: null,
                    type: shipType.type
                };
                
                ships.push(newShip);
                
                // Son d'achat
                audioManager.playSound('purchase');
                
                showNotification(`${shipIcon} ${newShip.name} achet√© !`, '#4CAF50');
                updateDisplay();
                updateShopDisplay();
                saveGame();
            } else {
                audioManager.playSound('error');
            }
        }

        function updateBankDisplay() {
            // Mettre √† jour le r√©sum√© financier
            document.getElementById('bank-liquid-money').textContent = Math.floor(gameState.money).toLocaleString() + '‚Ç¨';
            document.getElementById('bank-savings').textContent = Math.floor(gameState.savings).toLocaleString() + '‚Ç¨';
            document.getElementById('bank-debt').textContent = Math.floor(gameState.debt).toLocaleString() + '‚Ç¨';
            
            const netWorth = gameState.money + gameState.savings - gameState.debt;
            const netWorthElement = document.getElementById('bank-net-worth');
            netWorthElement.textContent = Math.floor(netWorth).toLocaleString() + '‚Ç¨';
            netWorthElement.style.color = netWorth >= 0 ? '#4CAF50' : '#ff6b6b';
            
            // Informations sur le pr√™t
            const loanInfo = document.getElementById('loan-info');
            if (gameState.debt > 0) {
                const hourlyInterest = Math.floor(gameState.debt * gameState.loanInterestRate);
                loanInfo.innerHTML = `
                    <div class="loan-info">
                        <h4>Pr√™t Actuel</h4>
                        <p>Montant d√ª: ${Math.floor(gameState.debt).toLocaleString()}‚Ç¨</p>
                        <p>Int√©r√™ts par heure: ${hourlyInterest.toLocaleString()}‚Ç¨ (5%)</p>
                        
                        <div class="input-group">
                            <label>Montant √† rembourser:</label>
                            <input type="number" id="repay-amount" placeholder="Montant (laisser vide pour tout rembourser)">
                        </div>
                        
                        <button class="bank-btn" onclick="repayLoanPartial()">Remboursement Partiel</button>
                        <button class="bank-btn" onclick="repayLoanFull()" style="background: #FF5722;">Rembourser Tout</button>
                    </div>
                `;
            } else {
                loanInfo.innerHTML = '<p>Aucun pr√™t en cours</p>';
            }
        }

        function deposit() {
            const amount = parseInt(document.getElementById('deposit-amount').value);
            if (amount > 0 && gameState.money >= amount) {
                gameState.money -= amount;
                gameState.savings += amount;
                document.getElementById('deposit-amount').value = '';
                
                // Son d'argent
                audioManager.playSound('coin');
                
                showNotification(`${amount.toLocaleString()}‚Ç¨ d√©pos√© !`, '#4CAF50');
                updateDisplay();
                saveGame();
            } else if (amount > 0) {
                audioManager.playSound('error');
            }
        }

        function withdraw() {
            const amount = parseInt(document.getElementById('deposit-amount').value);
            if (amount > 0 && gameState.savings >= amount) {
                gameState.savings -= amount;
                gameState.money += amount;
                document.getElementById('deposit-amount').value = '';
                
                // Son d'argent
                audioManager.playSound('coin');
                
                showNotification(`${amount.toLocaleString()}‚Ç¨ retir√© !`, '#4CAF50');
                updateDisplay();
                saveGame();
            } else if (amount > 0) {
                audioManager.playSound('error');
            }
        }

        function takeLoan() {
            const amount = parseInt(document.getElementById('loan-amount').value);
            if (amount > 0 && gameState.debt === 0) {
                gameState.money += amount;
                gameState.debt += amount;
                document.getElementById('loan-amount').value = '';
                showNotification(`Pr√™t de ${amount.toLocaleString()}‚Ç¨ accord√© !`, '#2196F3');
                updateDisplay();
                updateBankDisplay();
                saveGame();
            } else if (gameState.debt > 0) {
                showNotification('Remboursez votre pr√™t actuel d\'abord !', '#ff6b6b');
            }
        }

        function repayLoanPartial() {
            const amount = parseInt(document.getElementById('repay-amount').value);
            
            if (!amount || amount <= 0) {
                showNotification('Veuillez entrer un montant valide !', '#ff6b6b');
                return;
            }
            
            if (gameState.money < amount) {
                showNotification('Fonds insuffisants !', '#ff6b6b');
                return;
            }
            
            if (amount > gameState.debt) {
                showNotification('Le montant d√©passe votre dette !', '#ff6b6b');
                return;
            }
            
            gameState.money -= amount;
            gameState.debt -= amount;
            document.getElementById('repay-amount').value = '';
            
            showNotification(`${amount.toLocaleString()}‚Ç¨ rembours√© ! Dette restante: ${Math.floor(gameState.debt).toLocaleString()}‚Ç¨`, '#4CAF50');
            updateDisplay();
            updateBankDisplay();
            saveGame();
        }

        function repayLoanFull() {
            if (gameState.money >= gameState.debt) {
                gameState.money -= gameState.debt;
                const paidAmount = Math.floor(gameState.debt);
                gameState.debt = 0;
                showNotification(`Pr√™t de ${paidAmount.toLocaleString()}‚Ç¨ enti√®rement rembours√© ! üéâ`, '#4CAF50');
                updateDisplay();
                updateBankDisplay();
                saveGame();
            } else {
                showNotification('Fonds insuffisants pour rembourser la totalit√© !', '#ff6b6b');
            }
        }

        function repayLoan() {
            // Fonction pour compatibilit√© (redirige vers remboursement total)
            repayLoanFull();
        }

        function showNotification(message, color = '#4CAF50') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = color;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // Fonction pour forcer la sauvegarde
        function forceSave() {
            saveGame();
            
            // Son de succ√®s pour la sauvegarde
            audioManager.playSound('coin');
            
            showNotification('üíæ Partie sauvegard√©e avec succ√®s !', '#4CAF50');
        }

        // Fonction pour confirmer le reset
        function confirmReset() {
            const confirmMessage = "‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\n√ätes-vous s√ªr de vouloir recommencer une nouvelle partie ?\n\nToutes vos donn√©es actuelles seront perdues :\n‚Ä¢ Argent et XP\n‚Ä¢ Navires et am√©liorations\n‚Ä¢ Progression et destinations d√©bloqu√©es\n‚Ä¢ S√©rie de r√©compenses quotidiennes\n\nCette action est IRR√âVERSIBLE !";
            
            if (confirm(confirmMessage)) {
                resetGame();
            }
        }

        // Fonction pour reset le jeu
        function resetGame() {
            // Supprimer la sauvegarde
            localStorage.removeItem('maritimeTycoonSave');
            
            // R√©initialiser l'√©tat du jeu aux valeurs par d√©faut
            gameState = {
                money: 10000,
                xp: 0,
                savings: 0,
                debt: 0,
                passiveIncome: 0,
                portLevel: 1,
                cargoShips: [
                    { id: 1, name: "Cargo Express", level: 1, capacity: 100, onMission: false, missionEnd: 0, destination: null, type: "cargo" }
                ],
                passengerShips: [
                    { id: 2, name: "Ferry Starter", level: 1, capacity: 150, onMission: false, missionEnd: 0, destination: null, type: "passenger" }
                ],
                missions: [],
                loanInterestRate: 0.05,
                savingsInterestRate: 0.02,
                lastSave: Date.now(),
                currentFleetTab: "cargo",
                lastDailyReward: 0,
                dailyRewardStreak: 0,
                lastMissionRefresh: 0
            };
            
            // R√©initialiser les destinations
            cargoDestinations.forEach(dest => {
                dest.unlocked = dest.requiredXP === 0;
            });
            passengerDestinations.forEach(dest => {
                dest.unlocked = dest.requiredXP === 0;
            });
            
            // Sauvegarder le nouvel √©tat
            saveGame();
            
            // Mettre √† jour l'affichage
            updateDisplay();
            updateUnlockedDestinations();
            
            // Afficher confirmation
            audioManager.playSound('daily_reward');
            showNotification('üîÑ Nouvelle partie commenc√©e ! Bon voyage capitaine ! ‚öì', '#2196F3');
        }

        // Charger la sauvegarde
        function loadGame() {
            const saved = localStorage.getItem('maritimeTycoonSave');
            if (saved) {
                const savedState = JSON.parse(saved);
                
                // R√©trocompatibilit√© pour les anciennes sauvegardes
                if (savedState.ships && !savedState.cargoShips) {
                    savedState.cargoShips = savedState.ships.map(ship => ({
                        ...ship,
                        type: 'cargo'
                    }));
                    savedState.passengerShips = [
                        { id: Date.now(), name: "Ferry Starter", level: 1, capacity: 150, onMission: false, missionEnd: 0, destination: null, type: "passenger" }
                    ];
                    delete savedState.ships;
                }
                
                // Fusionner avec l'√©tat par d√©faut
                gameState = { 
                    ...gameState, 
                    ...savedState,
                    currentFleetTab: savedState.currentFleetTab || 'cargo',
                    lastDailyReward: savedState.lastDailyReward || 0,
                    dailyRewardStreak: savedState.dailyRewardStreak || 0,
                    lastMissionRefresh: savedState.lastMissionRefresh || 0
                };
                
                updateUnlockedDestinations();
                
                const timeOffline = Date.now() - gameState.lastSave;
                if (timeOffline > 60000) {
                    processOfflineProgress(timeOffline);
                }
                
                // V√©rifier si on peut r√©cup√©rer des r√©compenses quotidiennes manqu√©es
                checkMissedDailyRewards(timeOffline);
                
                checkCompletedMissions();
            }
        }

        function checkMissedDailyRewards(timeOffline) {
            const rewardCooldown = 24 * 60 * 60 * 1000; // 24 heures r√©elles
            
            const daysMissed = Math.floor(timeOffline / rewardCooldown);
            
            if (daysMissed > 0 && gameState.lastDailyReward > 0) {
                let totalMissedReward = 0;
                
                // Calculer les r√©compenses manqu√©es (max 3 jours de rattrapage)
                const maxCatchup = Math.min(daysMissed, 3);
                
                for (let i = 0; i < maxCatchup; i++) {
                    const baseReward = 1000;
                    const streakBonus = (gameState.dailyRewardStreak + i) * 500;
                    totalMissedReward += baseReward + streakBonus;
                }
                
                if (totalMissedReward > 0) {
                    gameState.money += totalMissedReward;
                    gameState.dailyRewardStreak += maxCatchup;
                    gameState.lastDailyReward = Date.now() - (timeOffline % rewardCooldown);
                    
                    showNotification(`üéÅ Rattrapage ! Vous avez r√©cup√©r√© ${maxCatchup} r√©compenses quotidiennes : +${totalMissedReward.toLocaleString()}‚Ç¨`, '#FFC107');
                }
            }
        }

        function saveGame() {
            gameState.lastSave = Date.now();
            localStorage.setItem('maritimeTycoonSave', JSON.stringify(gameState));
        }

        function updateUnlockedDestinations() {
            cargoDestinations.forEach(dest => {
                if (gameState.xp >= dest.requiredXP) {
                    dest.unlocked = true;
                }
            });
            passengerDestinations.forEach(dest => {
                if (gameState.xp >= dest.requiredXP) {
                    dest.unlocked = true;
                }
            });
        }

        function processOfflineProgress(timeOffline) {
            let offlineEarnings = 0;
            let offlineXP = 0;
            let completedMissions = 0;
            
            if (gameState.savings > 0) {
                const minutesOffline = timeOffline / 60000;
                const savingsInterest = gameState.savings * (gameState.savingsInterestRate * minutesOffline);
                gameState.savings += savingsInterest;
                offlineEarnings += savingsInterest;
            }
            
            if (gameState.debt > 0) {
                const minutesOffline = timeOffline / 60000;
                const debtInterest = gameState.debt * (gameState.loanInterestRate * minutesOffline);
                gameState.debt += debtInterest;
            }
            
            const allShips = [...gameState.cargoShips, ...gameState.passengerShips];
            allShips.forEach(ship => {
                if (ship.onMission && ship.missionEnd <= Date.now()) {
                    const destinations = ship.type === "cargo" ? cargoDestinations : passengerDestinations;
                    const destination = destinations.find(d => d.name === ship.destination);
                    if (destination) {
                        const reward = Math.floor(destination.baseReward * gameState.portLevel * (ship.capacity * ship.level / 100));
                        const xpReward = destination.baseXP;
                        
                        offlineEarnings += reward;
                        offlineXP += xpReward;
                        completedMissions++;
                        
                        ship.onMission = false;
                        ship.destination = null;
                        ship.missionEnd = 0;
                    }
                }
            });
            
            if (completedMissions > 0) {
                gameState.money += offlineEarnings;
                gameState.xp += offlineXP;
                showNotification(`Pendant votre absence: ${completedMissions} missions termin√©es! +${Math.floor(offlineEarnings)}‚Ç¨ +${offlineXP}XP`, '#4CAF50');
            }
        }

        function checkCompletedMissions() {
            const allShips = [...gameState.cargoShips, ...gameState.passengerShips];
            allShips.forEach(ship => {
                if (ship.onMission && ship.missionEnd <= Date.now()) {
                    completeMission(ship);
                }
            });
        }

        function completeMission(ship) {
            const destinations = ship.type === "cargo" ? cargoDestinations : passengerDestinations;
            const destination = destinations.find(d => d.name === ship.destination);
            if (destination) {
                const reward = Math.floor(destination.baseReward * gameState.portLevel * (ship.capacity * ship.level / 100));
                const xpReward = destination.baseXP;
                
                gameState.money += reward;
                gameState.xp += xpReward;
                
                ship.onMission = false;
                ship.destination = null;
                ship.missionEnd = 0;
                
                updateUnlockedDestinations();
                const shipType = ship.type === "cargo" ? "üö¢" : "üõ≥Ô∏è";
                
                // Son de mission r√©ussie
                audioManager.playSound('mission_success');
                
                showNotification(`${shipType} ${ship.name} est revenu ! +${reward}‚Ç¨ +${xpReward}XP`, '#4CAF50');
                updateDisplay();
                
                saveGame();
            }
        }

        function formatDuration(milliseconds) {
            const hours = Math.floor(milliseconds / 3600000);
            const minutes = Math.floor((milliseconds % 3600000) / 60000);
            
            if (hours > 0) {
                return `${hours}h${minutes > 0 ? minutes + 'm' : ''}`;
            } else {
                return `${minutes}m`;
            }
        }

        // Syst√®me de revenus passifs et d'int√©r√™ts
        setInterval(() => {
            if (gameState.savings > 0) {
                const interest = gameState.savings * gameState.savingsInterestRate;
                gameState.savings += interest;
                gameState.passiveIncome = interest;
            }
            
            if (gameState.debt > 0) {
                const interest = gameState.debt * gameState.loanInterestRate;
                gameState.debt += interest;
            }
            
            updateDisplay();
            saveGame();
        }, 60000); // Chaque minute

        // V√©rification des missions en temps r√©el
        setInterval(() => {
            checkCompletedMissions();
            
            // Renouveler automatiquement les missions toutes les 10 minutes
            const now = Date.now();
            const missionRefreshInterval = 10 * 60 * 1000; // 10 minutes
            if (now - gameState.lastMissionRefresh >= missionRefreshInterval) {
                gameState.lastMissionRefresh = now;
                // Renouveler toutes les missions
                [...cargoDestinations, ...passengerDestinations].forEach(dest => {
                    dest.lastRefresh = now;
                });
                
                if (document.getElementById('fleet-screen').classList.contains('active')) {
                    updateFleetDisplay();
                    showNotification('üîÑ Nouvelles missions disponibles !', '#FF9800');
                }
            }
            
            if (document.getElementById('fleet-screen').classList.contains('active')) {
                updateFleetDisplay();
            }
            
            // Mettre √† jour le compteur de r√©compense quotidienne sur la page principale
            if (document.getElementById('main-screen').classList.contains('active')) {
                updateMainDailyRewardDisplay();
            }
        }, 1000); // Chaque seconde

        // Sauvegarde automatique toutes les 30 secondes
        setInterval(() => {
            saveGame();
        }, 30000);

        // Sauvegarder avant de fermer la page
        window.addEventListener('beforeunload', () => {
            saveGame();
        });

        // Initialisation
        loadGame();
        updateDisplay();
        updateUnlockedDestinations();
        
        // Initialiser l'audio au premier clic (requis par les navigateurs)
        document.addEventListener('click', () => {
            audioManager.initialize();
        }, { once: true });
    </script>
</body>
</html>